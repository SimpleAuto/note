#创建高性能的索引

###也就做key,是存储引擎用于快速找到记录的一种数据结构

##索引基础
- **先在索引中找到对应值,然后根据匹配的索引记录找到对应的数据行**
- **索引可以包含一个或者多个列的值**
###索引的类型
####B-Tree索引,使用B-Tree数据结构存储数据,意味着所有的值都是按顺序存储的,B-Tree索引能够加快访问数据的速度,从索引的根节点开始进行搜索,根节点存放了指向子节点的指针,存储引擎根据这个指针向下层查找,通过比较节点页的值和要查找的值可以找到合适的指针进入下层子节点
- **叶子节点的指针指向被索引的数据,而不是其他的节点页**
- **因为是顺序组织存储的,所以适合查找范围数据**
#####可以使用B-Tree索引的查询类型.B-Tree索引适合用于全键值,键值范围或者键前缀查找,其中键前缀查找只适用于根据最左前缀的查找
- **全值匹配**
- **匹配最左前缀**
- **匹配列前缀**
- **匹配范围值**
- **精确匹配某一列并范围匹配到另外一列**
- **只访问索引的查询**

#####使用B-Tree索引的限制
- **如果不是按照索引的最左列开始查找,则无法使用索引**
- **不能跳过索引中的列**
- **如果查询中某个列的范围查询,则其右边所有列都无法使用索引优化查找**

####哈希索引,基于哈希表实现,只有精确匹配索引所有列的查询才有效.对于每一行数据,存储引擎都会对所有的索引列计算一个哈希码,哈希索引将所有的哈希码存储在索引中,同时在哈希表中保存指向每个数据行的指针
- **只有memory引擎显式支持哈希索引**
- **如果多个列的哈希值相同,索引会以链表的方式存放多个记录指针到同一个哈希条目中**
#####哈希索引的限制
- **哈希索引只含哈希值和行指针,而不存储字段值,所以不能使用索引中的值来避免读取行**
- **哈希索引数据并不是按照索引值顺序存储的,无法用于排序**
- **哈希索引也不支持部分索引列匹配查找,因为哈希索引始终是使用索引列的全部内容来计算哈希值的**
- **哈希索引只支持等值比较查询,不支持范围查询**
- **访问哈希索引的数据非常快,如果有哈希冲突,存储引擎必须遍历链表中所有的行指针,逐行进行比较,直到找到所有符合条件的行**
- **如果哈希冲突很多的话,一些索引维护操作的代价也会很高**
#####Innodb引擎内置了"自适应哈希索引",当某些索引值被使用的非常频繁时,他会在内存中基于B-Tree索引之上再创建一个哈希索引,这是一个完全自动的,内部的行动,用户无法控制或者配置,可以主动关闭
#####创建自定义哈希索引,思路:在B-Tree基础上创建一个伪哈希索引,还是使用B-Tree进行查找,但是它使用哈希值而不是键本身进行索引查找

####空间数据索引(R-Tree),Myisam表支持空间索引,可以用作地理数据存储,空间索引会从所有维度来索引数据

####全文索引,查找的是文本中的关键词,而不是直接比较索引中的值,适用于MATCH AGAINS操作而不是普通的WHERE条件匹配

##索引的优点
###可以让服务器快速地定位到表的指定位置
- **索引大大减少了服务器需要扫描的数据量**
- **索引可以帮助服务器避免排序和临时表**
- **索引可以将随机I/O变为顺序I/O**

##高性能的索引策略
###正确地创建和使用索引是实现高性能查询的基础
- **独立的列,指索引列不能是表达式的一部分,也不能使函数的参数**
- **前缀索引和索引选择性,使用left函数,left(a,b),a是字段名称,右边是前缀字母的个数**
- **多列索引**
- **选择合适的索引列顺序**
- **聚簇索引,是一种数据存储方式,优点,可以把相关数据保存在一起,数据访问更快,使用覆盖索引扫描的查询可以直接使用页节点中的主键值;缺点,聚簇数据最大限度地提高了I/O密集型应用的性能,但如果数据全部都放在内存中,则访问的顺序就没那么重要了.插入速度严重依赖于插入顺序.更新聚簇索引列的代价很高,因为会强制Innodb将每个被更新的行移动到新的位置.基于聚簇索引的表在插入新行,或者主键被更新导致需要移动行的时候,可能面临"页分裂"的问题.聚簇索引可能导致全表扫描变慢.二级索引可能会更大.二级索引访问需要两次索引查找,因为二级索引中叶子节点保存的不是指向行的物理位置的指针,而是行的主键值**

###Innodb支持聚簇索引,聚簇索引的每一个叶子节点都包含了主键值,事务ID,用于事务和MVCC的回滚指针以及所有的剩余列,如果主键是一个列前缀索引,Innodb也会包含完整的主键列和剩下的其他列
###按照顺序插入,这样插入操作不会造成大量页分裂,随机插入会导致数据大量移动,但在高并发的时候,按照顺序插入会造成争用情况.

##使用索引扫描来做排序
###Mysql使用两种方式生成有序的结果,通过排序操作或者按索引顺序扫描

##压缩(前缀压缩)索引
###Myisam使用前缀压缩来减少索引的大小,从而让更多的索引可以放入内存中,默认只压缩字符串,但通过参数设置也可以对整数做压缩,Myisam压缩每个索引块的方法是,先完全保存索引块中的第一个值,然后将其他值和第一个进行比较得到相同前缀的字节数和剩余的不同后缀部分,把这部分存储起来

##冗余和重复索引
###Mysql允许在相同列上创建多个索引,Mysql需要单独维护重复的索引,并且优化器在优化查询时也需要逐个地进行考虑
###重复索引是指在相同的列上按照相同的顺序创建的相同类型的索引,需要避免
###冗余索引通常发生在为表添加新索引的时候

##索引和锁
###索引可以让查询锁定更少的行,锁定超过需要的行会增加锁争用并减少并发性

##维护索引和表
###维护表的目的,找到并修复损坏的表,维护准确的索引统计信息,减少碎片
###减少索引和数据的碎片
- **行碎片:指的是数据行被存储为多个地方的多个片段中,即使查询只从索引中访问一行记录,行碎片也会导致性能下降**
- **行间碎片:是指逻辑上顺序的页,或者行在磁盘上不是顺序存储的**
- **剩余空间碎片:剩余空间碎片是指数据页中有大量的空余空间,这会导致服务器读取大量不需要的数据,从而造成浪费**

##总结,在选择索引和编写利用这些索引的查询时,有如下三个原则:
- **1.单行访问是很慢的,使用索引可以创建位置引用以提升效率**
- **2.按顺序访问范围数据时很快的,第一,顺序I/O不要多次磁盘寻道,第二,如果服务器能够按照顺序读取数据,那就不需要额外的排序操作**
- **3.索引覆盖查询很快的,如果一个索引包含了查询需要的所有列,那么存储引擎就不需要再回表找行**
###总的来说,编写查询语句时应该尽可能选择合适的索引以避免单行查找,尽可能地使用数据原生顺序从而避免额外的排序操作,并尽可能使用索引覆盖查询

