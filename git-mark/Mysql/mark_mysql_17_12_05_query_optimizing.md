#查询性能优化

##慢查询基础:优化数据访问
###查询性能底下最基本的原因是访问的数据太多,大部分性能底下的查询都可以通过减少访问的数据量的方式进行优化
- **确认应用程序是否在检索大量超过需要的数据**
- **确认Mysql服务器层是否在分析大量超过需要的数据行**
###需要确认的点
- **是否向数据库请求了不需要的数据**
- **Mysql是否在扫描额外的记录**

##重构查询的方式
- **一个复杂查询还是多个简单查询**
- **切分查询.分而治之**
- **分解关联查询**
###用分解关联查询的方式重构的优势:
####1.让缓存的效率更高,缓存单表查询对应的结果对象
####2.将查询分解后,执行单个查询可以减少锁的竞争
####3.在应用层做关联,可以更容易对数据库进行拆分,更容易做到高性能和可扩展
####4.查询本身效率也可能会有所提升
####5.可以减少冗余记录的查询

##查询执行的基础
####1.客户端发送一条查询给服务器
####2.服务器先检查查询缓存,如果命中了缓存,则立刻返回存储在缓存中的结果,else,进入下一步
####3.服务器端进行SQL解析,预处理,再由优化器生成对应的执行计划
####4.Mysql根据优化器生成的执行计划,调用存储引擎的API来执行查询
####5.将结果返回给客户端

###Mysql客户端/服务器通信协议
####Mysql客户端和服务器之间的通信协议是"半双工的",在任一时刻,只能由一方发送数据
####查询状态,对于一个Mysql连接,或者说一个线程,任何时刻都有一个状态,该状态表示了Mysql当前正在做什么
- **Sleep:线程正在等待客户端发送新的请求**
- **Query:线程正在执行查询或者正在将结果发送给客户端**
- **Locked:在Mysql服务器层,该线程正在等待表锁**
- **Analyzing and statistics:线程正在收集存储引起的统计信息,并生成查询的执行计划**
- **Copying to tmp table[on disk]:线程正在执行查询,并且将其结果集都复制到一个临时表中(group by/文件排序/Union操作)**
- **Sorting result:线程正在对结果集进行排序**
- **Senging data:这表示多种情况:线程可能在多个状态之间传送数据,或者在生成结果集,或者在向客户端返回数据**

###查询缓存是通过一个对大小写敏感的哈希查找实现的,查询和缓存中的查询即使有一个字节不同,就不会匹配缓存结果
###查询优化处理,将一个SQL转换为一个执行计划,Mysql再按照这个执行计划和存储引擎进行交互,包括:解析SQL,预处理,优化SQL执行计划
####语法解析器和预处理
#####Mysql通过关键字将SQL语句进行解析,并生成一颗对应的"解析树".Mysql解析器将使用Mysql语法规则验证和解析查询.
#####预处理器则根据一些Mysql规则进一步检查解析树是否合法,还会验证权限
####查询优化器
#####语法树已经合法,并且由优化器将其转化成执行计划,一条查询可以有很多种执行方式,最后都返回相同的结果
